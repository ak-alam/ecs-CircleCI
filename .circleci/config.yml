version: 2.1

jobs:
  build_and_push:
    machine:
      image: ubuntu-2004:2022.10.1
    steps:
      - checkout
      - run:
          name: Install AWS CLI
          command: |
            aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
            aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
            aws configure set default.region us-west-1

      - run:
          name: ECR Login
          command: |
            make ecr-login ECR_REPO=${ECR_REPO_FLASK}
      
      - run:
          name: Build & Push
          command: |
            TAG=$CIRCLE_SHA1
            make build-image ECR_REPO=${ECR_REPO_FLASK} IMAGE_TAG=${TAG}

      - run:
          name: Deploy To ECS using ecs deploy
          command: |
            pip install ecs-deploy
            make deploy-task CLUSTER_NAME="flask-circleCI" SERVICE_NAME="flask-backend" IMAGE_TAG="latest"
# make deploy-task CLUSTER_NAME="circle_ci_flask" SERVICE_NAME=""flask-api
            

# curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
# unzip awscliv2.zip
# sudo ./aws/install


# aws ecr get-login-password --region us-west-1 | docker login --username AWS --password-stdin 489994096722.dkr.ecr.us-west-1.amazonaws.com

workflows:
  my-workflow:
    jobs:
      - build_and_push:
          context:
            - test